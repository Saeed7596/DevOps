# What is `iptables`?

`iptables` is a powerful Linux command-line tool for managing firewall rules and controlling network traffic. It allows administrators to define rules that filter, route, and manipulate packets passing through the system.

---

## **Core Concepts of `iptables`**

### **Tables**
`iptables` organizes rules into different tables. Each table serves a specific purpose:
1. **`filter` (default)**: Used for packet filtering.
2. **`nat`**: Handles Network Address Translation (e.g., port forwarding).
3. **`mangle`**: Allows modification of packet headers.
4. **`raw`**: Bypasses connection tracking for specific packets.

---

### **Chains**
Each table contains chains where rules are applied:
- **`INPUT`**: Processes packets destined for the local machine.
- **`OUTPUT`**: Processes packets generated by the local machine.
- **`FORWARD`**: Processes packets being routed through the machine.
- **`PREROUTING` and `POSTROUTING`** (in `nat` and `mangle` tables): Handle packets before and after routing.

---

### **Rules**
Rules define actions for packets based on criteria such as:
- Protocol (`-p tcp`).
- Source IP (`-s 192.168.1.0/24`).
- Destination IP (`-d 10.0.0.1`).
- Ports (`--dport 80`).

---

### **Targets**
Targets specify what happens to packets matching a rule:
- **`ACCEPT`**: Allow the packet.
- **`DROP`**: Discard the packet silently.
- **`REJECT`**: Discard the packet and notify the sender.
- **`LOG`**: Log the packet details.
- **`DNAT`, `SNAT`, `MASQUERADE`**: Modify the packet's IP/port.

---
## **Flags for iptables Commands**
Here are some common flags used with `iptables`:
- `-A` (or `--append`): Adds a rule to the end of a chain.
- `-D` (or `--delete`): Deletes a specific rule by its number or definition.
- `-I` (or `--insert`): Inserts a rule at a specific position.
- `-R` (or `--replace`): Replaces a rule at a specific position.
- `-F` (or `--flush`): Removes all rules from a chain.
- `-L` (or `--list`): Lists all rules in a chain.
- `-N` (or `--new-chain`): Creates a new custom chain.
- `-X` (or `--delete-chain`): Deletes a custom chain.
- `-P` (or `--policy`): Sets the default action for a chain.
- `-Z` (or `--zero`): Resets packet/byte counters.
- `-t` (or `--table`): Specifies the table (default is `filter`).

---

### **Viewing Rules**
List current rules:
```bash
iptables -L -v
```
List current rules with line numbers:
```bash
iptables -L --line-numbers
```
Lists the current NAT (Network Address Translation) rules in the firewall with detailed statistics like packet counts and byte sizes.
```
iptables -nvL -t nat
```

---

## **Adding Rules**
```bash
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
```
Flags used:
- `-A`: Append a rule to the end of a chain.
- `-p tcp`: Specify the protocol (e.g., TCP).
- `--dport 80`: Match packets targeting port 80.
- `-j ACCEPT`: Set the action to accept the packet.
Deleting Rules:
```bash
iptables -D INPUT 1
```
Flags used:
- `-D`: Delete a rule from a chain.
- `1`: Line number of the rule to delete.

---

# Saving and Restoring `iptables` Rules

To ensure your `iptables` rules persist after a system reboot, you need to save and restore them. Here are the steps to save and restore `iptables` rules.

---

## **Saving Rules**
Save the current `iptables` configuration to a file:
```bash
iptables-save > /etc/iptables/rules.v4
```
## **Restoring Rules**
To restore the saved `iptables` configuration:
```bash
iptables-restore < /etc/iptables/rules.v4
```
Similarly, for IPv6 rules:
```bash
ip6tables-save > /etc/iptables/rules.v6
ip6tables-restore < /etc/iptables/rules.v6
```

---

## **Examples of Common `iptables` Commands:**
#### Example 1: Allow SSH Access
Allow incoming SSH traffic on port 22:
```bash
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
```
#### Example 2: Block Traffic from a Specific IP
Block all traffic from `192.168.1.100`:
```bash
iptables -A INPUT -s 192.168.1.100 -j DROP
```
#### Example 6: Flush All Rules and Reset Policies
Clear all rules and set policies to `ACCEPT`:
```bash
iptables -F
iptables -X
iptables -P INPUT ACCEPT
iptables -P OUTPUT ACCEPT
iptables -P FORWARD ACCEPT
```
